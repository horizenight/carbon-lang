<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-design docs-doc-id-generics/appendix-coherence">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<title data-rh="true">Carbon: alternatives to coherence | Carbon Language</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://emlai.github.io/carbon-lang/design/generics/appendix-coherence"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-design-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-design-current"><meta data-rh="true" property="og:title" content="Carbon: alternatives to coherence | Carbon Language"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/carbon-lang/img/carbon-logo.png"><link data-rh="true" rel="canonical" href="https://emlai.github.io/carbon-lang/design/generics/appendix-coherence"><link data-rh="true" rel="alternate" href="https://emlai.github.io/carbon-lang/design/generics/appendix-coherence" hreflang="en"><link data-rh="true" rel="alternate" href="https://emlai.github.io/carbon-lang/design/generics/appendix-coherence" hreflang="x-default"><link rel="stylesheet" href="/carbon-lang/assets/css/styles.009a6ecf.css">
<link rel="preload" href="/carbon-lang/assets/js/runtime~main.256c0991.js" as="script">
<link rel="preload" href="/carbon-lang/assets/js/main.5fcc8113.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/carbon-lang/"><div class="navbar__logo"><img src="/carbon-lang/img/carbon-logo.png" alt="Carbon Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/carbon-lang/img/carbon-logo.png" alt="Carbon Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Carbon Language</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/carbon-lang/design">Design</a><a class="navbar__item navbar__link" href="/carbon-lang/spec">Spec</a><a class="navbar__item navbar__link" href="/carbon-lang/project">Project</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/carbon-language/carbon-lang" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design">Language design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/aliases">Aliases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/blocks_and_statements">Blocks and statements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/classes">Classes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/carbon-lang/design/code_and_name_organization">Code and name organization</a><button aria-label="Toggle the collapsible sidebar category &#x27;Code and name organization&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/carbon-lang/design/control_flow">Control flow</a><button aria-label="Toggle the collapsible sidebar category &#x27;Control flow&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/carbon-lang/design/expressions">Expressions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Expressions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/functions">Functions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/carbon-lang/design/generics">Generics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Generics&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/carbon-lang/design/generics/appendix-coherence">Carbon: alternatives to coherence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/carbon-lang/design/generics/details">Generics: Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/carbon-lang/design/generics/goals">Generics: Goals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/carbon-lang/design/generics/overview">Generics: Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/carbon-lang/design/generics/terminology">Generics: Terminology</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/carbon-lang/design/interoperability">Bidirectional interoperability with C/C++</a><button aria-label="Toggle the collapsible sidebar category &#x27;Bidirectional interoperability with C/C++&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/carbon-lang/design/lexical_conventions">Lexical conventions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lexical conventions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/metaprogramming">Metaprogramming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/name_lookup">Name lookup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/naming_conventions">Naming conventions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/pattern_matching">Pattern matching</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/primitive_types">Primitive types</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/templates">Templates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/tuples">Tuples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/type_inference">Type inference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/carbon-lang/design/variables">Variables</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/carbon-lang/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/carbon-lang/design/generics"><span itemprop="name">Generics</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Carbon: alternatives to coherence</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Carbon: alternatives to coherence</h1><p>This document explains the rationale for choosing to make
<a href="/carbon-lang/design/generics/terminology#coherence">implementation coherence</a>
<a href="/carbon-lang/design/generics/goals#coherence">a goal for Carbon</a>, and the alternatives considered.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="table-of-contents">Table of contents<a class="hash-link" href="#table-of-contents" title="Direct link to heading">​</a></h2><ul><li><a href="#approach-taken-coherence">Approach taken: coherence</a></li><li><a href="#the-hashtable-problem">The &quot;Hashtable Problem&quot;</a></li><li><a href="#rejected-alternative-no-orphan-rule">Rejected alternative: no orphan rule</a></li><li><a href="#rejected-alternative-incoherence">Rejected alternative: incoherence</a><ul><li><a href="#incoherence-means-context-sensitivity">Incoherence means context sensitivity</a></li><li><a href="#rejected-variation-dynamic-implementation-binding">Rejected variation: dynamic implementation binding</a></li><li><a href="#rejected-variation-manual-conflict-resolution">Rejected variation: manual conflict resolution</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="approach-taken-coherence">Approach taken: coherence<a class="hash-link" href="#approach-taken-coherence" title="Direct link to heading">​</a></h2><p>The main thing to understand is that coherence is a desirable property, but to
get that property we need an orphan rule, and that rule has a cost. It in
particular limits how much control users of a type have over how that type
implements interfaces. There are a few main problematic use cases to consider:</p><ul><li>Selecting between multiple implementations of an interface for a type. For
example selecting the implementation of the <code>Comparable</code> interface for a
<code>Song</code> type to support &quot;by title&quot;, &quot;by artist&quot;, and &quot;by album&quot; orderings.</li><li>Implementing an interface for a type when there is no relationship between
the libraries defining the interface and the type.</li><li>When the implementation of an interface for a type uses an associated type
that can&#x27;t be referenced from the file or files where the implementation is
allowed to be defined.</li></ul><p>These last two cases are highlighted as concerns in Rust in
<a href="https://github.com/rust-lang/rfcs/issues/1856" target="_blank" rel="noopener noreferrer">Rust RFC #1856: orphan rules are stricter than we would like</a>.</p><p>Since Carbon is bundling interface implementations into types, for the
convenience and expressiveness that provides, we satisfy those use cases by
giving the user control over the type of a value. This means having facilities
for defining new <a href="/carbon-lang/design/generics/terminology#compatible-types">compatible types</a> with
different interface implementations, and casting between those types as needed.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-hashtable-problem">The &quot;Hashtable Problem&quot;<a class="hash-link" href="#the-hashtable-problem" title="Direct link to heading">​</a></h2><p>The &quot;Hashtable problem&quot; is that the specific hash function used to compute the
hash of keys in a hashtable must be the same when adding an entry, when looking
it up, and other operations like resizing. So a hashtable type is dependent on
both the key type, and the key type&#x27;s implementation of the <code>Hashable</code>
interface. If the key type can have more than one implementation of <code>Hashable</code>,
there needs to be some mechanism for choosing a single one to be used
consistently by the hashtable type, or the invariants of the type will be
violated.</p><p>Without the orphan rule to enforce coherence, we might have a situation like
this:</p><ul><li><p>Package <code>Container</code> defines a <code>HashSet</code> type.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package Container;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct HashSet(Key:! Hashable) { ... }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>A <code>Song</code> type is defined in package <code>SongLib</code>.</p></li><li><p>Package <code>SongHashArtistAndTitle</code> defines an implementation of <code>Hashable</code> for
<code>SongLib.Song</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package SongHashArtistAndTitle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import SongLib;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl SongLib.Song as Hashable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fn Hash[me: Self]() -&gt; u64 { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Package <code>SongUtil</code> uses the <code>Hashable</code> implementation from
<code>SongHashArtistAndTitle</code> to define a function <code>IsInHashSet</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package SongUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import SongLib;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import SongHashArtistAndTitle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import Containers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn IsInHashSet(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s: SongLib.Song,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h: Containers.HashSet(SongLib.Song)*) -&gt; bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return h-&gt;Contains(s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Package <code>SongHashAppleMusicURL</code> defines a different implementation of
<code>Hashable</code> for <code>SongLib.Song</code> than package <code>SongHashArtistAndTitle</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package SongHashAppleMusicURL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import SongLib;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl SongLib.Song as Hashable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fn Hash[me: Self]() -&gt; u64 { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Finally, package <code>Trouble</code> imports <code>SongHashAppleMusicURL</code>, creates a hash
set, and then calls the <code>IsInHashSet</code> function from package <code>SongUtil</code>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package Trouble;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import SongLib;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import SongHashAppleMusicURL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import Containers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import SongUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn SomethingWeirdHappens() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var unchained_melody: SongLib.Song = ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var song_set: auto = Containers.HashSet(SongLib.Song).Create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  song_set.Add(unchained_melody);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Either this is a compile error or does something unexpected.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (SongUtil.IsInHashSet(unchained_melody, &amp;song_set)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Print(&quot;This is expected, but doesn&#x27;t happen.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Print(&quot;This is what happens even though it is unexpected.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>The issue is that in package <code>Trouble</code>, the <code>song_set</code> is created in a context
where <code>SongLib.Song</code> has a <code>Hashable</code> implementation from
<code>SongHashAppleMusicURL</code>, and stores <code>unchained_melody</code> under that hash value.
When we go to look up the same song in <code>SongUtil.IsInHashSet</code>, it uses the hash
function from <code>SongHashArtistAndTitle</code> which returns a different hash value for
<code>unchained_melody</code>, and so reports the song is missing.</p><p><strong>Background:</strong> <a href="https://gist.github.com/nikomatsakis/1421744" target="_blank" rel="noopener noreferrer">This post</a>
discusses the hashtable problem in the context of Haskell, and
<a href="https://mail.mozilla.org/pipermail/rust-dev/2011-December/001036.html" target="_blank" rel="noopener noreferrer">this 2011 Rust followup</a>
discusses how to detect problems at compile time.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rejected-alternative-no-orphan-rule">Rejected alternative: no orphan rule<a class="hash-link" href="#rejected-alternative-no-orphan-rule" title="Direct link to heading">​</a></h2><p>In Swift an implementation of an interface, or a &quot;protocol&quot; as it is called in
Swift, can be provided in any module. As long as any module provides an
implementation, that implementation is
<a href="https://stackoverflow.com/questions/48762971/swift-protocol-conformance-by-extension-between-frameworks" target="_blank" rel="noopener noreferrer">used globally throughout the program</a>.</p><p>In Swift, since some protocol implementations can come from the runtime
environment provided by the operating system, multiple implementations for a
protocol can arise as a runtime warning. When this happens, Swift picks one
implementation arbitrarily.</p><p>In Carbon, we could make this a build time error. However, there would be
nothing preventing two independent libraries from providing conflicting
implementations. Furthermore, the error would only be diagnosed at link time.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rejected-alternative-incoherence">Rejected alternative: incoherence<a class="hash-link" href="#rejected-alternative-incoherence" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="incoherence-means-context-sensitivity">Incoherence means context sensitivity<a class="hash-link" href="#incoherence-means-context-sensitivity" title="Direct link to heading">​</a></h3><p>The undesirable result of incoherence is that the interpretation of source code
changes based on imports. In particular, imagine there is a function call that
depends on a type implementing an interface, and two different implementations
are defined in two different libraries. A call to that function will be treated
differently depending on which of those two libraries are imported:</p><ul><li>If neither is imported, it is an error.</li><li>If both are imported, it is ambiguous.</li><li>If only one is imported, you get totally different code executed depending
on which it is.</li></ul><p>Furthermore, this means that the behavior of a file can depend on an import even
if nothing from that package is referenced explicitly. In general, Carbon is
<a href="/carbon-lang/docs/project/principles/low_context_sensitivity.md">avoiding this sort of context sensitivity</a>.
This context sensitivity would make moving code between files when refactoring
more difficult and less safe.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rejected-variation-dynamic-implementation-binding">Rejected variation: dynamic implementation binding<a class="hash-link" href="#rejected-variation-dynamic-implementation-binding" title="Direct link to heading">​</a></h3><p>One possible approach would be to bind interface implementations to a value at
the point it was created. In <a href="#the-hashtable-problem">the example above</a>, the
implementation of the <code>Hashable</code> interface for <code>Song</code> would be fixed for the
<code>song_set</code> <code>HashSet</code> object based on which implementation was in scope in the
body of the <code>SomethingWeirdHappens</code> function.</p><p>This idea is discussed briefly in section 5.4 on separate compilation of WG21
proposal n1848 for implementing &quot;Indiana&quot; C++0x concepts
(<a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.86.9526&amp;rep=rep1&amp;type=pdf" target="_blank" rel="noopener noreferrer">1</a>,
and <a href="https://wg21.link/n1848" target="_blank" rel="noopener noreferrer">2</a>).</p><p>This has some downsides:</p><ul><li>It is harder to reason about. The behavior of <code>SongUtil.IsInHashSet</code> depends
on the dynamic behavior of the program. At the time of the call, we may have
no idea where the <code>HashSet</code> argument was created.</li><li>An object may be created far from a call that has a particular interface
requirement, with no guarantee that the object was created with any
implementation of the interface at all. This error would only be detected at
runtime, not at type checking time.</li><li>It requires more data space at runtime because we need to store a pointer to
the witness table representing the implementation with the object, since it
varies instead of being known statically.</li><li>It is slower to execute from dynamic dispatch and the inability to inline.</li><li>In some cases it may not be feasible to use dynamic dispatch. For example,
if an interface method returns an associated type, we might not know the
calling convention of the function without knowing some details about the
type.</li></ul><p>As a result, this doesn&#x27;t make sense as the default behavior for Carbon based on
its <a href="/carbon-lang/docs/project/goals.md">goals</a>. That being said, this could be a feature
added later as opt-in behavior to either allow users to reduce code size or
support use cases that require dynamic dispatch.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rejected-variation-manual-conflict-resolution">Rejected variation: manual conflict resolution<a class="hash-link" href="#rejected-variation-manual-conflict-resolution" title="Direct link to heading">​</a></h3><p>Carbon could alternatively provide some kind of manual disambiguation syntax to
resolve problems where they arise. The problems with this approach have been
<a href="https://github.com/Ixrec/rust-orphan-rules#whats-wrong-with-incoherence" target="_blank" rel="noopener noreferrer">considered in the context of Rust</a>.</p><p>A specific example of this approach is called
<a href="https://forums.swift.org/t/scoped-conformances/37159" target="_blank" rel="noopener noreferrer">scoped conformance</a>,
where the conflict resolution is based on limiting the visibility of
implementations to particular scopes. This hasn&#x27;t been implemented, but it has
the drawbacks described above. Depending on the details of the implementation,
either:</p><ul><li>there are incompatible values with types that have the same name, or</li><li>it is difficult to reason about the program&#x27;s behavior because it behaves
like
<a href="#rejected-variation-dynamic-implementation-binding">dynamic implementation binding</a>
(though perhaps with a monomorphization cost instead of a runtime cost).</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/carbon-language/carbon-lang/blob/trunk/../docs/design/generics/appendix-coherence.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/carbon-lang/design/generics"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Generics</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/carbon-lang/design/generics/details"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Generics: Details</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of contents</a></li><li><a href="#approach-taken-coherence" class="table-of-contents__link toc-highlight">Approach taken: coherence</a></li><li><a href="#the-hashtable-problem" class="table-of-contents__link toc-highlight">The &quot;Hashtable Problem&quot;</a></li><li><a href="#rejected-alternative-no-orphan-rule" class="table-of-contents__link toc-highlight">Rejected alternative: no orphan rule</a></li><li><a href="#rejected-alternative-incoherence" class="table-of-contents__link toc-highlight">Rejected alternative: incoherence</a><ul><li><a href="#incoherence-means-context-sensitivity" class="table-of-contents__link toc-highlight">Incoherence means context sensitivity</a></li><li><a href="#rejected-variation-dynamic-implementation-binding" class="table-of-contents__link toc-highlight">Rejected variation: dynamic implementation binding</a></li><li><a href="#rejected-variation-manual-conflict-resolution" class="table-of-contents__link toc-highlight">Rejected variation: manual conflict resolution</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/carbon-language/carbon-lang" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/ZjVdShJDAs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/carbon-language/carbon-lang/blob/trunk/CODE_OF_CONDUCT.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code of Conduct<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/carbon-lang/assets/js/runtime~main.256c0991.js"></script>
<script src="/carbon-lang/assets/js/main.5fcc8113.js"></script>
</body>
</html>